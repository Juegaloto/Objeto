<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigitalObjects - Plataforma de Rentabilidad</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Variables CSS optimizadas */
        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --secondary: #06D6A0;
            --dark: #1E1B2E;
            --light: #F8FAFC;
            --gray: #6B7280;
            --danger: #EF4444;
            --warning: #F59E0B;
            --success: #10B981;
            --border-radius: 16px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        /* Estilos base optimizados */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1E1B2E 0%, #2D1B69 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header optimizado */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-size: 24px;
            font-weight: 700;
        }

        .logo i {
            font-size: 28px;
            color: var(--primary);
        }

        .auth-buttons {
            display: flex;
            gap: 15px;
        }

        /* Botones optimizados */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }

        .btn-success {
            background: var(--secondary);
        }

        .btn-success:hover {
            background: #05C28F;
            box-shadow: 0 5px 15px rgba(6, 214, 160, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Información de usuario optimizada */
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        /* Estadísticas optimizadas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
            color: white;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Contenido principal optimizado */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            transition: var(--transition);
            color: white;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Formularios optimizados */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            color: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Badges optimizados */
        .profit-badge {
            background: rgba(6, 214, 160, 0.2);
            color: var(--secondary);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        /* Grid de objetos optimizado */
        .objects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .object-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: var(--transition);
            border-left: 4px solid var(--primary);
            color: white;
        }

        .object-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .object-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .object-id {
            font-weight: 700;
            color: var(--primary);
        }

        .object-status {
            background: var(--secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .object-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .detail-value {
            font-weight: 600;
            font-size: 16px;
        }

        /* Barras de progreso optimizadas */
        .progress-container {
            margin: 15px 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Indicadores de ganancia optimizados */
        .profit-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(6, 214, 160, 0.1);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-top: 10px;
        }

        .profit-value {
            font-weight: 700;
            font-size: 18px;
            color: var(--secondary);
        }

        .profit-label {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Títulos de sección optimizados */
        .section-title {
            color: white;
            margin: 30px 0 20px;
            font-size: 24px;
            font-weight: 700;
        }

        /* Estados vacíos optimizados */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.3);
        }

        /* Historial de transacciones optimizado */
        .transaction-history {
            margin-top: 30px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            color: white;
        }

        .transaction-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .transaction-type {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .transaction-amount {
            font-weight: 600;
        }

        .transaction-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Sistema de Toast optimizado */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 1100;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background: var(--secondary);
        }

        .toast-error {
            background: var(--danger);
        }

        .toast-info {
            background: var(--primary);
        }

        /* Modal de autenticación optimizado */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: linear-gradient(135deg, #2D1B69 0%, #1E1B2E 100%);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 450px;
            padding: 30px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            border: 1px solid var(--glass-border);
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: white;
            transform: rotate(90deg);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            color: var(--gray);
            transition: var(--transition);
            flex: 1;
            text-align: center;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .address-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 14px;
        }

        .info-alert {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #93c5fd;
            padding: 12px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .warning-alert {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            color: #fcd34d;
            padding: 12px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        /* Referidos optimizados */
        .referral-section {
            margin-top: 30px;
        }

        .referral-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .referral-level {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
            color: white;
        }

        .referral-level:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .referral-level-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .referral-level-percentage {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--secondary);
        }

        .referral-level-count {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .referral-level-earnings {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .referral-link-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .referral-link {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 16px;
            border-radius: var(--border-radius);
            font-family: monospace;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .copy-btn:hover {
            background: var(--primary-dark);
        }

        /* Botón de información optimizado */
        .info-button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            cursor: pointer;
            transition: var(--transition);
            margin-left: 10px;
        }

        .info-button:hover {
            background: var(--primary);
            color: white;
        }

        /* Modal de información optimizado */
        .info-modal {
            max-width: 600px;
        }

        .info-content {
            line-height: 1.6;
        }

        .info-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 15px;
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        /* Responsive optimizado */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .auth-buttons {
                flex-direction: column;
            }
            
            .objects-grid {
                grid-template-columns: 1fr;
            }
            
            .object-details {
                grid-template-columns: 1fr;
            }
            
            .referral-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .section-title {
                font-size: 20px;
            }
            
            .card-title {
                font-size: 18px;
            }
        }

        /* Optimizaciones de rendimiento */
        .lazy-load {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .lazy-load.loaded {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-cube"></i>
                <span>DigitalObjects</span>
            </div>
            <div id="authButtons" class="auth-buttons">
                <button class="btn btn-outline" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    Iniciar Sesión
                </button>
                <button class="btn" id="registerBtn">
                    <i class="fas fa-user-plus"></i>
                    Registrarse
                </button>
            </div>
            <div id="userInfo" class="user-info" style="display: none;">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">Usuario</div>
                    <button class="btn-outline" id="logoutBtn" style="padding: 5px 10px; font-size: 12px;">
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalObjects">0</div>
                <div class="stat-label">Objetos Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalInvested">0 USDT</div>
                <div class="stat-label">Total Invertido</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEarned">0 USDT</div>
                <div class="stat-label">Ganancias Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="walletBalance">0 USDT</div>
                <div class="stat-label">Balance Actual</div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-plus-circle"></i>
                    Crear Nuevo Objeto
                </h2>
                <div class="form-group">
                    <label for="investmentAmount">Cantidad a Invertir (USDT)</label>
                    <input type="number" id="investmentAmount" min="10" step="1" placeholder="10" value="10">
                </div>
                <div class="form-group">
                    <label>Rentabilidad Diaria</label>
                    <div class="profit-badge">
                        <i class="fas fa-chart-line"></i>
                        <span>3% diario durante 15 días</span>
                    </div>
                </div>
                <button id="createObject" class="btn">
                    <i class="fas fa-cube"></i>
                    Crear Objeto Digital
                </button>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-wallet"></i>
                    Gestión de Fondos
                </h2>
                <div class="form-group">
                    <label>Balance Disponible</label>
                    <input type="text" id="availableBalance" value="0 USDT" readonly>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" id="depositBtn" style="flex: 1;">
                        <i class="fas fa-arrow-down"></i>
                        Depositar
                    </button>
                    <button class="btn btn-success" id="withdrawBtn" style="flex: 1;">
                        <i class="fas fa-arrow-up"></i>
                        Retirar
                    </button>
                </div>
            </div>
        </div>

        <!-- Sección de Referidos optimizada -->
        <div class="referral-section">
            <h2 class="section-title">
                Sistema de Referidos
                <button class="info-button" id="referralInfoBtn" title="Cómo funciona el sistema de referidos">
                    <i class="fas fa-info"></i>
                </button>
            </h2>
            <div class="card">
                <h3 class="card-title">
                    <i class="fas fa-users"></i>
                    Tu Enlace de Referido
                </h3>
                <div class="referral-link-container">
                    <div class="referral-link" id="referralLink">Cargando...</div>
                    <button class="copy-btn" id="copyReferralLink">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                
                <div class="referral-grid">
                    <div class="referral-level">
                        <div class="referral-level-title">Nivel 1</div>
                        <div class="referral-level-percentage">15%</div>
                        <div class="referral-level-count" id="level1Count">0</div>
                        <div class="referral-level-earnings" id="level1Earnings">0 USDT</div>
                    </div>
                    <div class="referral-level">
                        <div class="referral-level-title">Nivel 2</div>
                        <div class="referral-level-percentage">5%</div>
                        <div class="referral-level-count" id="level2Count">0</div>
                        <div class="referral-level-earnings" id="level2Earnings">0 USDT</div>
                    </div>
                    <div class="referral-level">
                        <div class="referral-level-title">Nivel 3</div>
                        <div class="referral-level-percentage">1%</div>
                        <div class="referral-level-count" id="level3Count">0</div>
                        <div class="referral-level-earnings" id="level3Earnings">0 USDT</div>
                    </div>
                </div>
            </div>
        </div>

        <h2 class="section-title">Tus Objetos Digitales</h2>
        <div id="objectsContainer" class="objects-grid">
            <div class="empty-state">
                <i class="fas fa-cubes"></i>
                <h3>No tienes objetos digitales</h3>
                <p>Inicia sesión y crea tu primer objeto para comenzar a generar ganancias</p>
            </div>
        </div>

        <div class="transaction-history">
            <h2 class="section-title">Historial de Transacciones</h2>
            <div class="card">
                <div id="transactionsList">
                    <div class="empty-state">
                        <i class="fas fa-exchange-alt"></i>
                        <h3>No hay transacciones</h3>
                        <p>Realiza tu primer depósito para comenzar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sistema de Toast optimizado -->
    <div id="toastContainer"></div>

    <!-- Modal de Autenticación optimizado -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="closeAuthModal">&times;</button>
            <h2 class="modal-title" id="authModalTitle">Iniciar Sesión</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="login">Iniciar Sesión</div>
                <div class="tab" data-tab="register">Registrarse</div>
            </div>

            <!-- Login Tab -->
            <div class="tab-content active" id="loginTab">
                <div class="form-group">
                    <label for="loginEmail">Correo Electrónico</label>
                    <input type="email" id="loginEmail" placeholder="tu@email.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Contraseña</label>
                    <input type="password" id="loginPassword" placeholder="••••••••">
                </div>
                <button class="btn" id="doLogin">
                    <i class="fas fa-sign-in-alt"></i>
                    Iniciar Sesión
                </button>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" id="showForgotPassword" style="color: var(--primary);">¿Olvidaste tu contraseña?</a>
                </div>
            </div>

            <!-- Register Tab -->
            <div class="tab-content" id="registerTab">
                <div class="form-group">
                    <label for="registerReferralCode">Código de Referido (Opcional)</label>
                    <input type="text" id="registerReferralCode" placeholder="Código de referido">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Correo Electrónico</label>
                    <input type="email" id="registerEmail" placeholder="tu@email.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Contraseña</label>
                    <input type="password" id="registerPassword" placeholder="••••••••">
                </div>
                <button class="btn" id="doRegister">
                    <i class="fas fa-user-plus"></i>
                    Crear Cuenta
                </button>
            </div>

            <!-- Forgot Password Tab -->
            <div class="tab-content" id="forgotTab">
                <div class="form-group">
                    <label for="forgotEmail">Correo Electrónico</label>
                    <input type="email" id="forgotEmail" placeholder="tu@email.com">
                </div>
                <button class="btn" id="doForgotPassword">
                    <i class="fas fa-envelope"></i>
                    Enviar Correo de Recuperación
                </button>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" id="backToLogin" style="color: var(--primary);">Volver al inicio de sesión</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Depósito optimizado -->
    <div id="depositModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="closeDepositModal">&times;</button>
            <h2 class="modal-title">Depositar USDT</h2>
            
            <div class="info-alert">
                <i class="fas fa-info-circle"></i> 
                <div>Depósito mínimo: 10 USDT. Solo se aceptan depósitos en red TRC20.</div>
            </div>

            <div class="form-group">
                <label for="depositAmount">Cantidad a Depositar (USDT)</label>
                <input type="number" id="depositAmount" min="10" step="1" placeholder="10" value="10">
            </div>

            <div class="address-box">
                <strong>Dirección para depósito:</strong><br>
                TCPHX13kbYT3yabcTyE9TANCASd6cdRqxx
            </div>

            <button class="btn" id="confirmDeposit">
                <i class="fas fa-check"></i>
                Confirmar Depósito
            </button>
        </div>
    </div>

    <!-- Modal de Retiro optimizado -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="closeWithdrawModal">&times;</button>
            <h2 class="modal-title">Retirar USDT</h2>
            
            <div class="info-alert">
                <i class="fas fa-info-circle"></i> 
                <div>Retiro mínimo: 10 USDT. Comisión de red: 1 USDT.</div>
            </div>

            <div class="form-group">
                <label for="withdrawAmount">Cantidad a Retirar (USDT)</label>
                <input type="number" id="withdrawAmount" min="10" step="1" placeholder="10" value="10">
            </div>

            <div class="form-group">
                <label for="withdrawAddress">Dirección de Retiro (TRC20)</label>
                <input type="text" id="withdrawAddress" placeholder="TU_Direccion_TRC20">
            </div>

            <div class="form-group">
                <label>Resumen del Retiro</label>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: var(--border-radius);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Monto a retirar:</span>
                        <span id="withdrawSummaryAmount">10 USDT</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Comisión de red:</span>
                        <span>1 USDT</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold;">
                        <span>Total a recibir:</span>
                        <span id="withdrawSummaryTotal">9 USDT</span>
                    </div>
                </div>
            </div>

            <button class="btn btn-success" id="confirmWithdraw">
                <i class="fas fa-paper-plane"></i>
                Solicitar Retiro
            </button>
        </div>
    </div>

    <!-- Modal de Información de Referidos -->
    <div id="referralInfoModal" class="modal">
        <div class="modal-content info-modal">
            <button class="modal-close" id="closeReferralInfoModal">&times;</button>
            <h2 class="modal-title">Cómo funciona el Sistema de Referidos</h2>
            
            <div class="info-content">
                <div class="info-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3>Comparte tu enlace</h3>
                        <p>Comparte tu enlace único de referido con amigos y conocidos. Cuando alguien se registre usando tu enlace, se convertirá en tu referido de nivel 1.</p>
                    </div>
                </div>
                
                <div class="info-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3>Gana comisiones</h3>
                        <p>Recibirás el 15% de los depósitos de tus referidos de nivel 1, el 5% de los depósitos de tus referidos de nivel 2, y el 1% de los depósitos de tus referidos de nivel 3.</p>
                    </div>
                </div>
                
                <div class="info-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3>Multiplica tus ganancias</h3>
                        <p>Cada persona que invites puede invitar a más personas, creando una red de referidos de hasta 3 niveles de profundidad.</p>
                    </div>
                </div>
                
                <div class="info-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h3>Retira tus ganancias</h3>
                        <p>Todas las comisiones de referidos se acreditan automáticamente a tu balance y puedes retirarlas en cualquier momento.</p>
                    </div>
                </div>
                
                <div class="warning-alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>Recuerda que las comisiones se calculan únicamente sobre los depósitos realizados por tus referidos, no sobre sus ganancias.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDD5e7SYFHqilDbdF9hLLgiOy4ITsnhUu0",
            authDomain: "objeto-214e1.firebaseapp.com",
            databaseURL: "https://objeto-214e1-default-rtdb.firebaseio.com",
            projectId: "objeto-214e1",
            storageBucket: "objeto-214e1.firebasestorage.app",
            messagingSenderId: "130368716293",
            appId: "1:130368716293:web:9e78ce2c5c7fcc3294a66c",
            measurementId: "G-CCYXFC89MB"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Estado de la aplicación optimizado
        const state = {
            currentUser: null,
            userData: null,
            objects: [],
            transactions: [],
            isAdmin: false,
            referralData: {
                level1: { count: 0, earnings: 0 },
                level2: { count: 0, earnings: 0 },
                level3: { count: 0, earnings: 0 }
            },
            // Nuevo: Cache para optimizar consultas
            cache: {
                objects: null,
                transactions: null,
                referralData: null
            }
        };

        // Elementos DOM optimizados
        const authButtons = document.getElementById('authButtons');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authModal = document.getElementById('authModal');
        const closeAuthModal = document.getElementById('closeAuthModal');
        const depositBtn = document.getElementById('depositBtn');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const depositModal = document.getElementById('depositModal');
        const closeDepositModal = document.getElementById('closeDepositModal');
        const withdrawModal = document.getElementById('withdrawModal');
        const closeWithdrawModal = document.getElementById('closeWithdrawModal');
        const createObjectBtn = document.getElementById('createObject');
        const investmentAmountInput = document.getElementById('investmentAmount');
        const objectsContainer = document.getElementById('objectsContainer');
        const transactionsList = document.getElementById('transactionsList');
        const totalObjectsEl = document.getElementById('totalObjects');
        const totalInvestedEl = document.getElementById('totalInvested');
        const totalEarnedEl = document.getElementById('totalEarned');
        const walletBalanceEl = document.getElementById('walletBalance');
        const availableBalanceInput = document.getElementById('availableBalance');
        const showForgotPassword = document.getElementById('showForgotPassword');
        const backToLogin = document.getElementById('backToLogin');
        const referralLink = document.getElementById('referralLink');
        const copyReferralLinkBtn = document.getElementById('copyReferralLink');
        const level1Count = document.getElementById('level1Count');
        const level1Earnings = document.getElementById('level1Earnings');
        const level2Count = document.getElementById('level2Count');
        const level2Earnings = document.getElementById('level2Earnings');
        const level3Count = document.getElementById('level3Count');
        const level3Earnings = document.getElementById('level3Earnings');
        const referralInfoBtn = document.getElementById('referralInfoBtn');
        const referralInfoModal = document.getElementById('referralInfoModal');
        const closeReferralInfoModal = document.getElementById('closeReferralInfoModal');

        // Tabs del modal de autenticación
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Funciones de utilidad optimizadas
        function formatCurrency(amount) {
            return `${parseFloat(amount).toFixed(2)} USDT`;
        }

        function calculateDailyProfit(investment) {
            return investment * 0.03;
        }

        function calculateTotalProfit(investment, days) {
            return investment * 0.03 * days;
        }

        function generateTransactionId() {
            return 'TX' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        function generateReferralCode() {
            return 'REF' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        // Sistema de Toast optimizado
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Manejo de errores de Firebase optimizado
        function handleFirebaseError(error, userFriendlyMessage = 'Ocurrió un error') {
            console.error('Firebase Error:', error);
            
            let message = userFriendlyMessage;
            
            const errorMap = {
                'auth/email-already-in-use': 'Este correo electrónico ya está registrado',
                'auth/invalid-email': 'El correo electrónico no es válido',
                'auth/weak-password': 'La contraseña debe tener al menos 6 caracteres',
                'auth/user-not-found': 'No existe una cuenta con este correo',
                'auth/wrong-password': 'Contraseña incorrecta',
                'auth/network-request-failed': 'Error de conexión. Verifica tu internet',
                'permission-denied': 'No tienes permisos para realizar esta acción'
            };
            
            if (errorMap[error.code]) {
                message = errorMap[error.code];
            }
            
            showToast(message, 'error');
            return message;
        }

        // Sistema de Referidos optimizado
        function setupReferralSystem() {
            // Generar código de referido si no existe
            if (state.currentUser && state.userData && !state.userData.referralCode) {
                const referralCode = generateReferralCode();
                db.collection('users').doc(state.currentUser.uid).update({
                    referralCode: referralCode
                })
                .then(() => {
                    state.userData.referralCode = referralCode;
                    updateReferralUI();
                })
                .catch((error) => {
                    console.error('Error al generar código de referido:', error);
                });
            }
            
            // Actualizar UI de referidos
            updateReferralUI();
            
            // Copiar enlace de referido
            copyReferralLinkBtn.addEventListener('click', () => {
                const link = referralLink.textContent;
                if (link === "Cargando..." || link === "Inicia sesión para ver tu enlace") {
                    showToast('No hay enlace disponible para copiar', 'error');
                    return;
                }
                
                navigator.clipboard.writeText(link)
                    .then(() => {
                        showToast('Enlace copiado al portapapeles', 'success');
                    })
                    .catch((err) => {
                        console.error('Error al copiar: ', err);
                        // Fallback para navegadores antiguos
                        const textArea = document.createElement('textarea');
                        textArea.value = link;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showToast('Enlace copiado al portapapeles', 'success');
                    });
            });
            
            // Botón de información de referidos
            referralInfoBtn.addEventListener('click', () => {
                referralInfoModal.style.display = 'flex';
            });
            
            closeReferralInfoModal.addEventListener('click', () => {
                referralInfoModal.style.display = 'none';
            });
            
            window.addEventListener('click', (event) => {
                if (event.target === referralInfoModal) {
                    referralInfoModal.style.display = 'none';
                }
            });
        }

        function updateReferralUI() {
            if (state.userData && state.userData.referralCode) {
                // Enlace directo al bot de Telegram con el código de referido
                const telegramBotLink = `https://t.me/DigitalObjects_bot?start=${state.userData.referralCode}`;
                referralLink.textContent = telegramBotLink;
            } else {
                referralLink.textContent = "Inicia sesión para ver tu enlace";
            }
            
            // Actualizar estadísticas de referidos
            level1Count.textContent = state.referralData.level1.count;
            level1Earnings.textContent = formatCurrency(state.referralData.level1.earnings);
            level2Count.textContent = state.referralData.level2.count;
            level2Earnings.textContent = formatCurrency(state.referralData.level2.earnings);
            level3Count.textContent = state.referralData.level3.count;
            level3Earnings.textContent = formatCurrency(state.referralData.level3.earnings);
        }

        function loadReferralData() {
            if (!state.currentUser) return;
            
            // Usar cache si está disponible
            if (state.cache.referralData && Date.now() - state.cache.referralData.timestamp < 30000) {
                state.referralData = state.cache.referralData.data;
                updateReferralUI();
                return;
            }
            
            // Cargar datos de referidos
            db.collection('referrals')
                .where('referrerId', '==', state.currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    state.referralData = {
                        level1: { count: 0, earnings: 0 },
                        level2: { count: 0, earnings: 0 },
                        level3: { count: 0, earnings: 0 }
                    };
                    
                    querySnapshot.forEach((doc) => {
                        const referral = doc.data();
                        const level = referral.level;
                        if (level >= 1 && level <= 3) {
                            state.referralData[`level${level}`].count++;
                            state.referralData[`level${level}`].earnings += referral.commission || 0;
                        }
                    });
                    
                    // Actualizar cache
                    state.cache.referralData = {
                        data: {...state.referralData},
                        timestamp: Date.now()
                    };
                    
                    updateReferralUI();
                })
                .catch((error) => {
                    console.error('Error al cargar datos de referidos:', error);
                });
        }

        function processReferralCommission(depositAmount, depositorId) {
            // Obtener información del usuario que depositó
            db.collection('users').doc(depositorId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        
                        // Procesar comisiones para hasta 3 niveles
                        let currentUserId = depositorId;
                        let currentLevel = 1;
                        
                        const processLevel = () => {
                            if (currentLevel > 3) return;
                            
                            // Obtener referente del usuario actual
                            db.collection('users').doc(currentUserId).get()
                                .then((userDoc) => {
                                    if (userDoc.exists) {
                                        const user = userDoc.data();
                                        
                                        if (user.referredBy) {
                                            // Calcular comisión según el nivel
                                            let commissionRate = 0;
                                            if (currentLevel === 1) commissionRate = 0.15;
                                            else if (currentLevel === 2) commissionRate = 0.05;
                                            else if (currentLevel === 3) commissionRate = 0.01;
                                            
                                            const commission = depositAmount * commissionRate;
                                            
                                            // Registrar la comisión
                                            db.collection('referrals').add({
                                                referrerId: user.referredBy,
                                                referredId: depositorId,
                                                level: currentLevel,
                                                commission: commission,
                                                depositAmount: depositAmount,
                                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                            })
                                            .then(() => {
                                                // Acreditar comisión al referente
                                                db.collection('users').doc(user.referredBy).get()
                                                    .then((referrerDoc) => {
                                                        if (referrerDoc.exists) {
                                                            const referrerData = referrerDoc.data();
                                                            const newBalance = (referrerData.balance || 0) + commission;
                                                            const newTotalEarned = (referrerData.totalEarned || 0) + commission;
                                                            
                                                            return db.collection('users').doc(user.referredBy).update({
                                                                balance: newBalance,
                                                                totalEarned: newTotalEarned
                                                            });
                                                        }
                                                    })
                                                    .then(() => {
                                                        // Registrar transacción de comisión
                                                        return db.collection('transactions').add({
                                                            userId: user.referredBy,
                                                            type: 'referral',
                                                            amount: commission,
                                                            status: 'completed',
                                                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                                            id: generateTransactionId(),
                                                            description: `Comisión de referido nivel ${currentLevel}`
                                                        });
                                                    })
                                                    .then(() => {
                                                        // Invalidar cache de referidos
                                                        state.cache.referralData = null;
                                                        
                                                        // Continuar con el siguiente nivel
                                                        currentUserId = user.referredBy;
                                                        currentLevel++;
                                                        processLevel();
                                                    });
                                            })
                                            .catch((error) => {
                                                console.error('Error al registrar comisión:', error);
                                            });
                                        }
                                    }
                                })
                                .catch((error) => {
                                    console.error('Error al obtener datos del usuario:', error);
                                });
                        };
                        
                        // Iniciar el proceso
                        processLevel();
                    }
                })
                .catch((error) => {
                    console.error('Error al obtener datos del depositante:', error);
                });
        }

        // Sistema de Autenticación optimizado
        function setupAuthListeners() {
            // Tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tabName + 'Tab').classList.add('active');
                    document.getElementById('authModalTitle').textContent = 
                        tabName === 'login' ? 'Iniciar Sesión' : 
                        tabName === 'register' ? 'Registrarse' : 'Recuperar Contraseña';
                });
            });

            // Mostrar recuperación de contraseña
            showForgotPassword.addEventListener('click', (e) => {
                e.preventDefault();
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                document.getElementById('forgotTab').classList.add('active');
                document.getElementById('authModalTitle').textContent = 'Recuperar Contraseña';
            });

            // Volver al inicio de sesión
            backToLogin.addEventListener('click', (e) => {
                e.preventDefault();
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                document.querySelector('.tab[data-tab="login"]').classList.add('active');
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('authModalTitle').textContent = 'Iniciar Sesión';
            });

            // Login
            document.getElementById('doLogin').addEventListener('click', () => {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showToast('Por favor completa todos los campos', 'error');
                    return;
                }

                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        state.currentUser = userCredential.user;
                        loadUserData();
                        authModal.style.display = 'none';
                        showToast('¡Bienvenido de nuevo!', 'success');
                    })
                    .catch((error) => {
                        handleFirebaseError(error, 'Error al iniciar sesión');
                    });
            });

            // Registro optimizado
            document.getElementById('doRegister').addEventListener('click', () => {
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const referralCode = document.getElementById('registerReferralCode').value.trim();
                
                if (!email || !password) {
                    showToast('Por favor completa todos los campos', 'error');
                    return;
                }

                if (password.length < 6) {
                    showToast('La contraseña debe tener al menos 6 caracteres', 'error');
                    return;
                }

                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        state.currentUser = userCredential.user;
                        
                        // Verificar si hay un código de referido válido
                        let referredBy = null;
                        if (referralCode) {
                            // Buscar usuario con ese código de referido
                            return db.collection('users').where('referralCode', '==', referralCode).get()
                                .then((querySnapshot) => {
                                    if (!querySnapshot.empty) {
                                        referredBy = querySnapshot.docs[0].id;
                                    }
                                    
                                    // Crear documento de usuario en Firestore
                                    return db.collection('users').doc(userCredential.user.uid).set({
                                        username: email.split('@')[0], // Usar parte del email como nombre de usuario
                                        email: email,
                                        balance: 0,
                                        totalInvested: 0,
                                        totalEarned: 0,
                                        referralCode: generateReferralCode(),
                                        referredBy: referredBy,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                                        isAdmin: false
                                    });
                                });
                        } else {
                            // Crear documento de usuario en Firestore sin referido
                            return db.collection('users').doc(userCredential.user.uid).set({
                                username: email.split('@')[0],
                                email: email,
                                balance: 0,
                                totalInvested: 0,
                                totalEarned: 0,
                                referralCode: generateReferralCode(),
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                                isAdmin: false
                            });
                        }
                    })
                    .then(() => {
                        loadUserData();
                        authModal.style.display = 'none';
                        showToast('¡Cuenta creada exitosamente!', 'success');
                    })
                    .catch((error) => {
                        handleFirebaseError(error, 'Error al crear la cuenta');
                    });
            });

            // Recuperar contraseña
            document.getElementById('doForgotPassword').addEventListener('click', () => {
                const email = document.getElementById('forgotEmail').value;
                
                if (!email) {
                    showToast('Por favor ingresa tu correo electrónico', 'error');
                    return;
                }

                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        showToast('Se ha enviado un correo para restablecer tu contraseña', 'success');
                        document.querySelector('.tab[data-tab="login"]').click();
                    })
                    .catch((error) => {
                        handleFirebaseError(error, 'Error al enviar el correo');
                    });
            });
        }

        // Cargar datos del usuario optimizado
        function loadUserData() {
            if (!state.currentUser) return;

            db.collection('users').doc(state.currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        state.userData = doc.data();
                        state.isAdmin = state.userData.isAdmin || false;
                        updateUI();
                        loadUserObjects();
                        loadUserTransactions();
                        loadReferralData();
                        setupReferralSystem();
                    } else {
                        console.error('No se encontró el documento del usuario');
                        showToast('Error al cargar datos del usuario', 'error');
                    }
                })
                .catch((error) => {
                    handleFirebaseError(error, 'Error al cargar datos del usuario');
                });
        }

        // Actualizar UI optimizado
        function updateUI() {
            if (state.currentUser && state.userData) {
                authButtons.style.display = 'none';
                userInfo.style.display = 'flex';
                userName.textContent = state.userData.username;
                userAvatar.textContent = state.userData.username.charAt(0).toUpperCase();
                
                // Actualizar estadísticas
                totalObjectsEl.textContent = state.objects.length;
                totalInvestedEl.textContent = formatCurrency(state.userData.totalInvested || 0);
                totalEarnedEl.textContent = formatCurrency(state.userData.totalEarned || 0);
                walletBalanceEl.textContent = formatCurrency(state.userData.balance || 0);
                availableBalanceInput.value = formatCurrency(state.userData.balance || 0);
            } else {
                authButtons.style.display = 'flex';
                userInfo.style.display = 'none';
            }
        }

        // Cargar objetos del usuario optimizado
        function loadUserObjects() {
            if (!state.currentUser) return;

            // Usar cache si está disponible
            if (state.cache.objects && Date.now() - state.cache.objects.timestamp < 30000) {
                state.objects = state.cache.objects.data;
                renderObjects();
                updateUI();
                return;
            }

            db.collection('objects')
                .where('userId', '==', state.currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    state.objects = [];
                    querySnapshot.forEach((doc) => {
                        const objectData = doc.data();
                        state.objects.push({
                            id: doc.id,
                            ...objectData
                        });
                    });
                    
                    // Actualizar cache
                    state.cache.objects = {
                        data: [...state.objects],
                        timestamp: Date.now()
                    };
                    
                    renderObjects();
                    updateUI();
                })
                .catch((error) => {
                    console.error('Error al cargar objetos:', error);
                    // Intentar sin ordenamiento si hay problemas de índice
                    if (error.code === 'failed-precondition') {
                        db.collection('objects')
                            .where('userId', '==', state.currentUser.uid)
                            .get()
                            .then((querySnapshot) => {
                                state.objects = [];
                                querySnapshot.forEach((doc) => {
                                    const objectData = doc.data();
                                    state.objects.push({
                                        id: doc.id,
                                        ...objectData
                                    });
                                });
                                // Ordenar manualmente por fecha
                                state.objects.sort((a, b) => {
                                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                                    return dateB - dateA;
                                });
                                
                                // Actualizar cache
                                state.cache.objects = {
                                    data: [...state.objects],
                                    timestamp: Date.now()
                                };
                                
                                renderObjects();
                                updateUI();
                            })
                            .catch((error2) => {
                                handleFirebaseError(error2, 'Error al cargar objetos');
                            });
                    } else {
                        handleFirebaseError(error, 'Error al cargar objetos');
                    }
                });
        }

        // Cargar transacciones del usuario optimizado
        function loadUserTransactions() {
            if (!state.currentUser) {
                console.log('No hay usuario autenticado');
                return;
            }

            // Usar cache si está disponible
            if (state.cache.transactions && Date.now() - state.cache.transactions.timestamp < 30000) {
                state.transactions = state.cache.transactions.data;
                renderTransactions();
                return;
            }

            console.log('Cargando transacciones para usuario:', state.currentUser.uid);

            // Intentar cargar con diferentes enfoques para mayor robustez
            const transactionsQuery = db.collection('transactions')
                .where('userId', '==', state.currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(20);

            transactionsQuery.get()
                .then((querySnapshot) => {
                    console.log(`Se encontraron ${querySnapshot.size} transacciones`);
                    
                    state.transactions = [];
                    querySnapshot.forEach((doc) => {
                        const transactionData = doc.data();
                        console.log('Transacción encontrada:', transactionData);
                        state.transactions.push({
                            id: doc.id,
                            ...transactionData
                        });
                    });
                    
                    // Actualizar cache
                    state.cache.transactions = {
                        data: [...state.transactions],
                        timestamp: Date.now()
                    };
                    
                    renderTransactions();
                })
                .catch((error) => {
                    console.error('Error específico al cargar transacciones:', error);
                    
                    // Intentar carga sin ordenamiento si hay problemas de índice
                    if (error.code === 'failed-precondition') {
                        console.log('Intentando carga sin ordenamiento...');
                        db.collection('transactions')
                            .where('userId', '==', state.currentUser.uid)
                            .limit(20)
                            .get()
                            .then((querySnapshot) => {
                                state.transactions = [];
                                querySnapshot.forEach((doc) => {
                                    state.transactions.push({
                                        id: doc.id,
                                        ...doc.data()
                                    });
                                });
                                // Ordenar manualmente por fecha
                                state.transactions.sort((a, b) => {
                                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                                    return dateB - dateA;
                                });
                                
                                // Actualizar cache
                                state.cache.transactions = {
                                    data: [...state.transactions],
                                    timestamp: Date.now()
                                };
                                
                                renderTransactions();
                            })
                            .catch((error2) => {
                                handleFirebaseError(error2, 'Error al cargar transacciones');
                            });
                    } else {
                        handleFirebaseError(error, 'Error al cargar transacciones');
                    }
                });
        }

        // Renderizar objetos optimizado
        function renderObjects() {
            if (state.objects.length === 0) {
                objectsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-cubes"></i>
                        <h3>No tienes objetos digitales</h3>
                        <p>Crea tu primer objeto para comenzar a generar ganancias</p>
                    </div>
                `;
                return;
            }
            
            objectsContainer.innerHTML = '';
            
            state.objects.forEach(obj => {
                const createdAt = obj.createdAt ? obj.createdAt.toDate() : new Date();
                const daysActive = Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24));
                const daysRemaining = Math.max(0, 15 - daysActive);
                const totalEarned = calculateTotalProfit(obj.investment, Math.min(daysActive, 15));
                const dailyProfit = calculateDailyProfit(obj.investment);
                const isActive = daysRemaining > 0;
                const progressPercentage = Math.min(100, (daysActive / 15) * 100);
                
                const objectCard = document.createElement('div');
                objectCard.className = 'object-card lazy-load';
                objectCard.innerHTML = `
                    <div class="object-header">
                        <div class="object-id">Objeto #${obj.id.substr(0, 8)}</div>
                        <div class="object-status" style="background: ${isActive ? '#06D6A0' : '#6b7280'}">
                            ${isActive ? 'Activo' : 'Expirado'}
                        </div>
                    </div>
                    <div class="object-details">
                        <div class="detail-item">
                            <span class="detail-label">Inversión</span>
                            <span class="detail-value">${formatCurrency(obj.investment)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Días activo</span>
                            <span class="detail-value">${daysActive}/15</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ganancia diaria</span>
                            <span class="detail-value">${formatCurrency(dailyProfit)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Total ganado</span>
                            <span class="detail-value">${formatCurrency(totalEarned)}</span>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-header">
                            <span>Progreso</span>
                            <span>${daysActive}/15 días</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                    <div class="profit-indicator">
                        <div>
                            <div class="profit-label">Ganancia en tiempo real</div>
                            <div class="profit-value">+${formatCurrency(dailyProfit)}/día</div>
                        </div>
                        <i class="fas fa-chart-line" style="font-size: 24px; color: var(--secondary);"></i>
                    </div>
                `;
                
                objectsContainer.appendChild(objectCard);
                
                // Carga diferida para mejor rendimiento
                setTimeout(() => {
                    objectCard.classList.add('loaded');
                }, 100);
            });
        }

        // Renderizar transacciones optimizado
        function renderTransactions() {
            console.log('Renderizando transacciones:', state.transactions);
            
            if (state.transactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exchange-alt"></i>
                        <h3>No hay transacciones</h3>
                        <p>Realiza tu primer depósito para comenzar</p>
                    </div>
                `;
                return;
            }
            
            transactionsList.innerHTML = '';
            
            state.transactions.forEach(transaction => {
                console.log('Procesando transacción:', transaction);
                
                const transactionItem = document.createElement('div');
                transactionItem.className = 'transaction-item lazy-load';
                
                const typeIcon = transaction.type === 'deposit' ? 'fa-arrow-down' : 
                               transaction.type === 'withdrawal' ? 'fa-arrow-up' : 
                               transaction.type === 'investment' ? 'fa-cube' : 
                               transaction.type === 'referral' ? 'fa-user-friends' : 'fa-coins';
                               
                const typeColor = transaction.type === 'deposit' ? '#06D6A0' : 
                                transaction.type === 'withdrawal' ? '#EF4444' : 
                                transaction.type === 'referral' ? '#8B5CF6' : '#8B5CF6';
                
                const amountPrefix = transaction.type === 'deposit' || transaction.type === 'profit' || transaction.type === 'referral' ? '+' : '-';
                
                // Formatear fecha
                let dateText = 'Fecha desconocida';
                if (transaction.createdAt) {
                    const date = transaction.createdAt.toDate ? transaction.createdAt.toDate() : new Date(transaction.createdAt);
                    dateText = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                }
                
                transactionItem.innerHTML = `
                    <div class="transaction-type">
                        <i class="fas ${typeIcon}" style="color: ${typeColor};"></i>
                        <div>
                            <div style="font-weight: 600;">${getTransactionTypeText(transaction.type)}</div>
                            <div style="font-size: 12px; opacity: 0.8;">${dateText}</div>
                            ${transaction.description ? `<div style="font-size: 12px; opacity: 0.8;">${transaction.description}</div>` : ''}
                        </div>
                    </div>
                    <div class="transaction-amount" style="color: ${typeColor};">
                        ${amountPrefix}${formatCurrency(transaction.amount)}
                    </div>
                    <div class="transaction-status status-${transaction.status || 'pending'}">
                        ${getStatusText(transaction.status || 'pending')}
                    </div>
                `;
                
                transactionsList.appendChild(transactionItem);
                
                // Carga diferida para mejor rendimiento
                setTimeout(() => {
                    transactionItem.classList.add('loaded');
                }, 100);
            });
        }

        function getTransactionTypeText(type) {
            const types = {
                'deposit': 'Depósito',
                'withdrawal': 'Retiro',
                'investment': 'Inversión',
                'profit': 'Ganancia',
                'referral': 'Comisión Referido'
            };
            return types[type] || type;
        }

        function getStatusText(status) {
            const statuses = {
                'pending': 'Pendiente',
                'completed': 'Completado',
                'failed': 'Fallido'
            };
            return statuses[status] || status;
        }

        // Crear objeto optimizado
        function createObject() {
            if (!state.currentUser) {
                showToast('Por favor, inicia sesión primero.', 'error');
                return;
            }
            
            const investment = parseFloat(investmentAmountInput.value);
            if (isNaN(investment) || investment < 10) {
                showToast('La inversión mínima es 10 USDT', 'error');
                return;
            }

            if (state.userData.balance < investment) {
                showToast('Saldo insuficiente. Por favor, realiza un depósito primero.', 'error');
                return;
            }

            const objectData = {
                userId: state.currentUser.uid,
                investment: investment,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'active'
            };

            // Actualizar balance del usuario
            const newBalance = state.userData.balance - investment;
            const newTotalInvested = (state.userData.totalInvested || 0) + investment;

            db.collection('objects').add(objectData)
                .then((docRef) => {
                    return db.collection('users').doc(state.currentUser.uid).update({
                        balance: newBalance,
                        totalInvested: newTotalInvested
                    });
                })
                .then(() => {
                    // Invalidar cache
                    state.cache.objects = null;
                    
                    // Crear transacción de inversión
                    return db.collection('transactions').add({
                        userId: state.currentUser.uid,
                        type: 'investment',
                        amount: investment,
                        status: 'completed',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        id: generateTransactionId()
                    });
                })
                .then(() => {
                    // Invalidar cache de transacciones
                    state.cache.transactions = null;
                    
                    loadUserData();
                    loadUserObjects();
                    investmentAmountInput.value = '10';
                    showToast('¡Objeto creado exitosamente!', 'success');
                })
                .catch((error) => {
                    handleFirebaseError(error, 'Error al crear el objeto');
                });
        }

        // Sistema de depósitos optimizado
        function setupDepositSystem() {
            depositBtn.addEventListener('click', () => {
                if (!state.currentUser) {
                    showToast('Por favor, inicia sesión primero.', 'error');
                    return;
                }
                depositModal.style.display = 'flex';
            });

            document.getElementById('confirmDeposit').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('depositAmount').value);
                
                if (isNaN(amount) || amount < 10) {
                    showToast('El depósito mínimo es 10 USDT', 'error');
                    return;
                }

                // Crear transacción de depósito pendiente
                db.collection('transactions').add({
                    userId: state.currentUser.uid,
                    type: 'deposit',
                    amount: amount,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    id: generateTransactionId(),
                    address: 'TCPHX13kbYT3yabcTyE9TANCASd6cdRqxx',
                    network: 'TRC20'
                })
                .then(() => {
                    // Invalidar cache de transacciones
                    state.cache.transactions = null;
                    
                    // Procesar comisiones de referidos
                    processReferralCommission(amount, state.currentUser.uid);
                    
                    depositModal.style.display = 'none';
                    showToast('Depósito registrado. Los fondos se acreditarán después de la confirmación.', 'success');
                    loadUserTransactions();
                })
                .catch((error) => {
                    handleFirebaseError(error, 'Error al registrar el depósito');
                });
            });
        }

        // Sistema de retiros optimizado
        function setupWithdrawSystem() {
            withdrawBtn.addEventListener('click', () => {
                if (!state.currentUser) {
                    showToast('Por favor, inicia sesión primero.', 'error');
                    return;
                }

                if (state.userData.balance < 10) {
                    showToast('Saldo insuficiente. El retiro mínimo es 10 USDT', 'error');
                    return;
                }

                document.getElementById('withdrawAmount').value = '10';
                document.getElementById('withdrawAddress').value = '';
                updateWithdrawSummary();
                withdrawModal.style.display = 'flex';
            });

            document.getElementById('withdrawAmount').addEventListener('input', updateWithdrawSummary);

            document.getElementById('confirmWithdraw').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('withdrawAmount').value);
                const address = document.getElementById('withdrawAddress').value.trim();
                
                if (isNaN(amount) || amount < 10) {
                    showToast('El retiro mínimo es 10 USDT', 'error');
                    return;
                }

                if (state.userData.balance < amount) {
                    showToast('Saldo insuficiente', 'error');
                    return;
                }

                if (!address || address.length < 10) {
                    showToast('Por favor ingresa una dirección válida', 'error');
                    return;
                }

                // Crear transacción de retiro
                const netAmount = amount - 1; // Comisión de 1 USDT

                db.collection('transactions').add({
                    userId: state.currentUser.uid,
                    type: 'withdrawal',
                    amount: amount,
                    netAmount: netAmount,
                    address: address,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    id: generateTransactionId(),
                    network: 'TRC20'
                })
                .then(() => {
                    // Invalidar cache de transacciones
                    state.cache.transactions = null;
                    
                    // Actualizar balance del usuario
                    return db.collection('users').doc(state.currentUser.uid).update({
                        balance: state.userData.balance - amount
                    });
                })
                .then(() => {
                    withdrawModal.style.display = 'none';
                    showToast('Retiro solicitado. Será procesado en las próximas 24 horas.', 'success');
                    loadUserData();
                    loadUserTransactions();
                })
                .catch((error) => {
                    handleFirebaseError(error, 'Error al solicitar el retiro');
                });
            });
        }

        function updateWithdrawSummary() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value) || 0;
            const netAmount = Math.max(0, amount - 1);
            
            document.getElementById('withdrawSummaryAmount').textContent = formatCurrency(amount);
            document.getElementById('withdrawSummaryTotal').textContent = formatCurrency(netAmount);
        }

        // Verificar código de referido en la URL optimizado
        function checkReferralCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            
            if (refCode) {
                // Prellenar el campo de código de referido en el registro
                document.getElementById('registerReferralCode').value = refCode;
                
                // Mostrar mensaje informativo
                showToast('Código de referido detectado. Será aplicado al registrarte.', 'info');
            }
        }

        // Event Listeners optimizados
        function setupEventListeners() {
            loginBtn.addEventListener('click', () => {
                authModal.style.display = 'flex';
                document.querySelector('.tab[data-tab="login"]').click();
            });

            registerBtn.addEventListener('click', () => {
                authModal.style.display = 'flex';
                document.querySelector('.tab[data-tab="register"]').click();
            });

            logoutBtn.addEventListener('click', () => {
                auth.signOut().then(() => {
                    state.currentUser = null;
                    state.userData = null;
                    state.objects = [];
                    state.transactions = [];
                    state.cache = {
                        objects: null,
                        transactions: null,
                        referralData: null
                    };
                    updateUI();
                    renderObjects();
                    renderTransactions();
                    showToast('Sesión cerrada correctamente', 'success');
                });
            });

            closeAuthModal.addEventListener('click', () => {
                authModal.style.display = 'none';
            });

            closeDepositModal.addEventListener('click', () => {
                depositModal.style.display = 'none';
            });

            closeWithdrawModal.addEventListener('click', () => {
                withdrawModal.style.display = 'none';
            });

            createObjectBtn.addEventListener('click', createObject);

            // Cerrar modales al hacer clic fuera
            window.addEventListener('click', (event) => {
                if (event.target === authModal) authModal.style.display = 'none';
                if (event.target === depositModal) depositModal.style.display = 'none';
                if (event.target === withdrawModal) withdrawModal.style.display = 'none';
            });
        }

        // Observador de autenticación optimizado
        auth.onAuthStateChanged((user) => {
            state.currentUser = user;
            if (user) {
                console.log('Usuario autenticado:', user.uid);
                loadUserData();
            } else {
                console.log('Usuario no autenticado');
                state.userData = null;
                state.objects = [];
                state.transactions = [];
                state.isAdmin = false;
                state.cache = {
                    objects: null,
                    transactions: null,
                    referralData: null
                };
                updateUI();
                renderObjects();
                renderTransactions();
            }
        });

        // Inicialización optimizada
        function init() {
            setupAuthListeners();
            setupEventListeners();
            setupDepositSystem();
            setupWithdrawSystem();
            checkReferralCode();
            updateUI();
            
            // Precarga de elementos críticos
            const preloadElements = document.querySelectorAll('.lazy-load');
            preloadElements.forEach(el => {
                setTimeout(() => {
                    el.classList.add('loaded');
                }, 100);
            });
        }

        // Ejecutar inicialización cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
